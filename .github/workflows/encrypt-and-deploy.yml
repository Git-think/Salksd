# GitHub Action: Encrypt and Deploy Scripts
# This workflow automates the process of encrypting shell scripts
# from the 'frps' branch and deploying them to the 'main' branch.

name: Encrypt and Sync to Main

# Trigger the workflow on pushes to the 'frps' branch, or manually
on:
  push:
    branches:
      - frps
  workflow_dispatch:

jobs:
  build-and-deploy:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the source code from the 'frps' branch
      - name: Checkout frps branch (source)
        uses: actions/checkout@v4
        with:
          ref: frps
          path: frps_source # Checkout to a specific subdirectory

      # Step 2: Obfuscate the scripts using obfsh
      - name: Obfuscate Scripts
        run: |
          # Install Python and pip
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          
          # Install obfsh
          pip3 install obfsh
          
          # Navigate to the source directory
          cd frps_source
          
          echo "Obfuscating frps.sh..."
          if [ -f "frps.sh" ]; then
            obfsh -i ./frps.sh -o ./frps.sh
          else
            echo "Warning: frps.sh not found."
          fi
          
          echo "Obfuscating frps-start.sh..."
          if [ -f "frps-start.sh" ]; then
            obfsh -i ./frps-start.sh -o ./frps-start.sh
          else
            echo "Warning: frps-start.sh not found."
          fi

      # Step 3: Checkout the 'main' branch to a separate directory
      - name: Checkout main branch (destination)
        uses: actions/checkout@v4
        with:
          ref: main
          path: main_dest

      # Step 4: Copy the obfuscated scripts to the main branch checkout
      - name: Copy scripts to main checkout
        run: |
          echo "Copying scripts..."
          # Copy the obfuscated frps.sh
          if [ -f "frps_source/frps.sh" ]; then
            cp frps_source/frps.sh main_dest/frps.sh
            echo "frps.sh copied."
          else
            echo "Warning: frps.sh not found."
          fi

          # Copy the obfuscated frps-start.sh
          if [ -f "frps_source/frps-start.sh" ]; then
            cp frps_source/frps-start.sh main_dest/frps-start.sh
            echo "frps-start.sh copied."
          else
            echo "Warning: frps-start.sh not found."
          fi

      # Step 5: Commit the changes and push to the 'main' branch
      - name: Commit and push to main
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: main_dest # Specify the directory to commit
          commit_message: "Automated: Sync and encrypt scripts from frps branch"
          branch: main
          # The action will only commit if there are changes
